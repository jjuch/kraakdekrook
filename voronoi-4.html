<!DOCTYPE html>
<meta charset="utf-8">
<style>

.triangles {
  fill: none;
}

.links {
  stroke: #000;
}

.sites {
  fill: rgb(255, 61, 213);
  stroke: rgb(195, 0, 255);
}

.triangles .primary {
  fill: rgb(91, 0, 177);
}

.links .primary {
  stroke: rgb(0, 69, 126);
}

.sites :first-child {
  fill: rgb(31, 0, 102);
}

</style>
<div id='level_3'>
    <svg id='svg_3' width="1920" height="300"></svg>
</div>
<div id='level_2'>
    <svg id='svg_2' width="1920" height="300"></svg>
</div>
<div id='level_1'>
    <svg id='svg_1' width="1920" height="300"></svg>
</div>
<div id='level_0'>
    <svg id='svg_0' width="1920" height="300"></svg>
</div>
<div id='level_-1'>
    <svg id='svg__1' width="1920" height="300"></svg>
</div>
<div id='level_-2'>
<svg id='svg__2' width="1920" height="300"></svg>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

const sites = {};

function init() {
  // verdiep3

  var voronoi = d3.voronoi();

  function redrawSite(site) {
    site
        .attr("cx", function(d) { return d[0]; })
        .attr("cy", function(d) { return d[1]; });
  }

  Object.keys(sites).forEach(function eachSite(level) {
    function moved() {
      sites[level][0] = d3.mouse(this);
      redraw();
    }
  
    function redraw() {
      var diagram = voronoi(sites[level]);
      triangle = triangle.data(diagram.triangles()), triangle.exit().remove();
      triangle = triangle.enter().append("path").merge(triangle).call(redrawtriangle);
      link = link.data(diagram.links()), link.exit().remove();
      link = link.enter().append("line").merge(link).call(redrawlink);
      site = site.data(sites[level]).call(redrawSite);
    }
  
    function redrawtriangle(triangle) {
      triangle
          .classed("primary", function(d) { return d[0] === sites[level][0] || d[1] === sites[level][0] || d[2] === sites[level][0]; })
          .attr("d", function(d) { return "M" + d.join("L") + "Z"; });
    }
  
    function redrawlink(link) {
      link
          .classed("primary", function(d) { return d.source === sites[level][0] || d.target === sites[level][0]; })
          .attr("x1", function(d) { return d.source[0]; })
          .attr("y1", function(d) { return d.source[1]; })
          .attr("x2", function(d) { return d.target[0]; })
          .attr("y2", function(d) { return d.target[1]; });
    }

    var svg = 
        d3.select(("#svg_" + level).replace('-', '_')).on("touchmove mousemove", moved),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var triangle = svg.append("g")
        .attr("class", "triangles")
      .selectAll("path")
      .data(voronoi.triangles(sites[level]))
      .enter().append("path")
        .call(redrawtriangle);

    var link = svg.append("g")
        .attr("class", "links")
      .selectAll("line")
      .data(voronoi.links(sites[level]))
      .enter().append("line")
        .call(redrawlink);

    var site = svg.append("g")
        .attr("class", "sites")
      .selectAll("circle")
      .data(sites[level])
      .enter().append("circle")
        .attr("r", 2.5)
        .call(redrawSite);
  });

}

d3.json('locations-parsed.json', function(data) {
    for (var i = 0; i < data.length; i++) {
        if (sites[data[i].level] == undefined) {
            sites[data[i].level] = []
        }
        sites[data[i].level].push([data[i].x, data[i].y]);
    }
    init();
});
</script>
